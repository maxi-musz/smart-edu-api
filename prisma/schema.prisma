generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model AcademicSession {
  id                    String                 @id @default(cuid())
  school_id             String
  academic_year         String
  start_year            Int
  end_year              Int
  term                  AcademicTerm
  start_date            DateTime
  end_date              DateTime
  status                AcademicSessionStatus  @default(active)
  is_current            Boolean                @default(false)
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  school                School                 @relation(fields: [school_id], references: [id])
  achievements          Achievement[]
  assessments           Assessment[]
  assessmentAttempts    AssessmentAttempt[]
  assessmentSubmissions AssessmentSubmission[]
  assignments           Assignment[]
  assignmentGrades      AssignmentGrade[]
  assignmentSubmissions AssignmentSubmission[]
  attendanceRecords     AttendanceRecord[]
  attendanceSessions    AttendanceSession[]
  attendanceSettings    AttendanceSettings[]
  attendanceSummaries   AttendanceSummary[]
  classes               Class[]
  gradingRubrics        GradingRubric[]
  notifications         Notification[]
  payments              Payment[]
  students              Student[]
  performances          StudentPerformance[]
  subjects              Subject[]
  teachers              Teacher[]
  schedules             TimetableEntry[]
  topics                Topic[]
  results               Result[]

  @@unique([school_id, academic_year, term])
  @@index([school_id, is_current])
  @@index([start_year, end_year])
  @@index([academic_year])
}

model School {
  id                    String                    @id @default(cuid())
  school_name           String
  school_email          String                    @unique
  school_phone          String
  school_address        String
  school_type           SchoolType
  school_ownership      SchoolOwnership
  status                SchoolStatus              @default(pending)
  school_icon           Json?
  cacId                 String?                   @unique
  utilityBillId         String?                   @unique
  taxClearanceId        String?                   @unique
  platformId            String?
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  academicSessions      AcademicSession[]
  achievements          Achievement[]
  assessments           Assessment[]
  assessmentAttempts    AssessmentAttempt[]
  assessmentSubmissions AssessmentSubmission[]
  assignments           Assignment[]
  assignmentGrades      AssignmentGrade[]
  assignmentSubmissions AssignmentSubmission[]
  attendanceRecords     AttendanceRecord[]
  attendanceSessions    AttendanceSession[]
  attendanceSettings    AttendanceSettings?
  attendanceSummaries   AttendanceSummary[]
  chatAnalytics         ChatAnalytics[]
  chatContexts          ChatContext[]
  chatConversations     ChatConversation[]
  chatMessages          ChatMessage[]
  classes               Class[]
  deviceTokens          DeviceToken[]
  documentChunks        DocumentChunk[]
  finance               Finance?
  gradingRubrics        GradingRubric[]
  libraryResource       LibraryResource[]
  liveClass             LiveClass[]
  materialProcessings   MaterialProcessing[]
  notifications         Notification[]
  pdfMaterial           PDFMaterial[]
  parents               Parent[]
  subscriptionPlan      PlatformSubscriptionPlan?
  cac                   Document?                 @relation("CACDoc", fields: [cacId], references: [id])
  platform              Organisation?             @relation(fields: [platformId], references: [id])
  tax_clearance         Document?                 @relation("TaxClearanceDoc", fields: [taxClearanceId], references: [id])
  utility_bill          Document?                 @relation("UtilityBillDoc", fields: [utilityBillId], references: [id])
  students              Student[]
  subjects              Subject[]
  supportInfo           SupportInfo?
  teachers              Teacher[]
  timeSlots             TimeSlot[]
  results               Result[]
  schedules             TimetableEntry[]
  topics                Topic[]
  users                 User[]
  userSettings          UserSettings[]
  videoContent          VideoContent[]
  wallet                Wallet?
}

model Document {
  id                 String  @id @default(cuid())
  secure_url         String
  public_id          String
  schoolCac          School? @relation("CACDoc")
  schoolTaxClearance School? @relation("TaxClearanceDoc")
  schoolUtilityBill  School? @relation("UtilityBillDoc")
}

model User {
  id                               String                                   @id @default(cuid())
  school_id                        String
  email                            String                                   @unique
  password                         String
  first_name                       String
  last_name                        String
  phone_number                     String
  display_picture                  Json?
  gender                           Gender                                   @default(other)
  otp                              String?                                  @default("")
  otp_expires_at                   DateTime?
  is_email_verified                Boolean?                                 @default(true)
  is_otp_verified                  Boolean?                                 @default(true)
  role                             Roles                                    @default(student)
  status                           UserStatus                               @default(active)
  createdAt                        DateTime                                 @default(now())
  updatedAt                        DateTime                                 @updatedAt
  filesUploadedThisMonth           Int                                      @default(0)
  lastFileResetDate                DateTime                                 @default(now())
  lastTokenResetDateAllTime        DateTime                                 @default(now())
  maxFileSizeMB                    Int                                      @default(100)
  maxFilesPerMonth                 Int                                      @default(10)
  maxMessagesPerWeek               Int                                      @default(100)
  maxStorageMB                     Int                                      @default(500)
  maxTokensPerDay                  Int                                      @default(50000)
  maxTokensPerWeek                 Int                                      @default(50000)
  messagesSentThisWeek             Int                                      @default(0)
  tokensUsedAllTime                Int                                      @default(0)
  tokensUsedThisDay                Int                                      @default(0)
  tokensUsedThisWeek               Int                                      @default(0)
  totalFilesUploadedAllTime        Int                                      @default(0)
  totalStorageUsedMB               Int                                      @default(0)
  assessmentsCreated               Assessment[]
  assessmentAttemptsGraded         AssessmentAttempt[]                      @relation("AssessmentGrader")
  assessmentAttempts               AssessmentAttempt[]
  assessmentResponses              AssessmentResponse[]
  assessmentGradesGiven            AssessmentSubmission[]                   @relation("AssessmentGrader")
  assessmentSubmissions            AssessmentSubmission[]
  assignmentsCreated               Assignment[]
  assignmentGradesReceived         AssignmentGrade[]
  assignmentGradesGiven            AssignmentGrade[]                        @relation("AssignmentGradeGiver")
  assignmentSubmissions            AssignmentSubmission[]
  attendanceRecordsMarked          AttendanceRecord[]                       @relation("AttendanceMarker")
  attendanceRecords                AttendanceRecord[]
  attendanceSessionsApproved       AttendanceSession[]                      @relation("AttendanceApprover")
  attendanceSummaries              AttendanceSummary[]
  chatAnalytics                    ChatAnalytics[]
  chatConversations                ChatConversation[]
  chatMessages                     ChatMessage[]
  deviceTokens                     DeviceToken[]
  gradingRubricsCreated            GradingRubric[]
  libraryResource                  LibraryResource[]
  liveClass                        LiveClass[]
  pdfMaterial                      PDFMaterial[]
  parent                           Parent?
  payments                         Payment[]                                @relation("StudentPayment")
  student                          Student?
  studentAchievements              StudentAchievement[]                     @relation("StudentAchievements")
  performances                     StudentPerformance[]                     @relation("StudentPerformance")
  teacher                          Teacher?
  topicsCreated                    Topic[]                                  @relation("TopicCreator")
  school                           School                                   @relation(fields: [school_id], references: [id])
  userSettings                     UserSettings?
  videoContent                     VideoContent[]
  resultsReleased                  Result[]                                 @relation("ResultReleasedBy")
  libraryComments                  LibraryComment[]
  generalMaterialPurchases         LibraryGeneralMaterialPurchase[]
  generalMaterialChatConversations LibraryGeneralMaterialChatConversation[]
  generalMaterialChatMessages      LibraryGeneralMaterialChatMessage[]
  libraryAssessmentAttemptsGraded  LibraryAssessmentAttempt[]               @relation("LibraryAssessmentGrader")
  libraryAssessmentAttempts        LibraryAssessmentAttempt[]
  libraryAssessmentResponses       LibraryAssessmentResponse[]
  examBodyAssessmentAttempts       ExamBodyAssessmentAttempt[]
  examBodyAssessmentResponses      ExamBodyAssessmentResponse[]
  libraryVideoViews                LibraryVideoView[]
  libraryVideoWatchHistory         LibraryVideoWatchHistory[]
  schoolVideoViews                 SchoolVideoView[]
  schoolVideoWatchHistory          SchoolVideoWatchHistory[]
}

model Teacher {
  id                  String              @id @default(cuid())
  email               String              @unique
  first_name          String
  last_name           String
  phone_number        String
  display_picture     Json?
  school_id           String
  academic_session_id String              @default("1")
  user_id             String              @unique
  gender              Gender              @default(other)
  role                Roles               @default(teacher)
  password            String              @default("")
  teacher_id          String              @unique
  employee_number     String?             @unique
  qualification       String?
  specialization      String?
  years_of_experience Int?
  hire_date           DateTime            @default(now())
  salary              Float?
  department          String?
  is_class_teacher    Boolean             @default(false)
  status              UserStatus          @default(active)
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  attendanceSessions  AttendanceSession[]
  classesManaging     Class[]             @relation("ClassTeacher")
  academicSession     AcademicSession     @relation(fields: [academic_session_id], references: [id])
  school              School              @relation(fields: [school_id], references: [id])
  user                User                @relation(fields: [user_id], references: [id], onDelete: Cascade)
  subjectsTeaching    TeacherSubject[]
  schedulesTeaching   TimetableEntry[]    @relation("TeacherSchedule")

  @@index([school_id])
  @@index([academic_session_id])
  @@index([teacher_id])
  @@index([employee_number])
  @@index([department])
  @@index([is_class_teacher])
}

model Student {
  id                  String          @id @default(cuid())
  school_id           String
  academic_session_id String
  user_id             String          @unique
  student_id          String          @unique
  admission_number    String?         @unique
  date_of_birth       DateTime?
  admission_date      DateTime        @default(now())
  current_class_id    String?
  guardian_name       String?
  guardian_phone      String?
  guardian_email      String?
  address             String?
  emergency_contact   String?
  blood_group         String?
  medical_conditions  String?
  allergies           String?
  previous_school     String?
  academic_level      String?
  parent_id           String?
  status              UserStatus      @default(active)
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt
  city                String?
  country             String?
  postal_code         String?
  state               String?
  academicSession     AcademicSession @relation(fields: [academic_session_id], references: [id])
  current_class       Class?          @relation(fields: [current_class_id], references: [id])
  parent              Parent?         @relation("ParentChildren", fields: [parent_id], references: [id])
  school              School          @relation(fields: [school_id], references: [id])
  user                User            @relation(fields: [user_id], references: [id], onDelete: Cascade)
  results             Result[]

  @@index([school_id])
  @@index([academic_session_id])
  @@index([current_class_id])
  @@index([student_id])
  @@index([admission_number])
  @@index([parent_id])
  @@index([academic_level])
}

model Parent {
  id                 String     @id @default(cuid())
  school_id          String
  user_id            String     @unique
  parent_id          String     @unique
  occupation         String?
  employer           String?
  address            String?
  emergency_contact  String?
  relationship       String?
  is_primary_contact Boolean    @default(true)
  status             UserStatus @default(active)
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt
  school             School     @relation(fields: [school_id], references: [id])
  user               User       @relation(fields: [user_id], references: [id], onDelete: Cascade)
  children           Student[]  @relation("ParentChildren")

  @@index([school_id])
  @@index([parent_id])
  @@index([relationship])
  @@index([is_primary_contact])
}

model Class {
  id                  String               @id @default(cuid())
  classId             Int                  @default(autoincrement())
  name                String
  schoolId            String
  academic_session_id String
  classTeacherId      String?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  attendanceRecords   AttendanceRecord[]
  attendanceSessions  AttendanceSession[]
  attendanceSummaries AttendanceSummary[]
  academicSession     AcademicSession      @relation(fields: [academic_session_id], references: [id])
  classTeacher        Teacher?             @relation("ClassTeacher", fields: [classTeacherId], references: [id])
  school              School               @relation(fields: [schoolId], references: [id])
  payments            Payment[]
  students            Student[]
  performances        StudentPerformance[]
  subjects            Subject[]
  schedules           TimetableEntry[]
  results             Result[]

  @@unique([schoolId, academic_session_id, classId])
  @@index([schoolId, academic_session_id])
  @@index([classId])
}

model Subject {
  id                  String           @id @default(cuid())
  name                String
  code                String?
  color               String           @default("#3B82F6")
  description         String?
  schoolId            String
  academic_session_id String
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
  classId             String?
  thumbnail           Json?
  assessments         Assessment[]
  academicSession     AcademicSession  @relation(fields: [academic_session_id], references: [id])
  Class               Class?           @relation(fields: [classId], references: [id])
  school              School           @relation(fields: [schoolId], references: [id])
  teacherSubjects     TeacherSubject[]
  timetableEntries    TimetableEntry[]
  topics              Topic[]

  @@unique([code, schoolId, academic_session_id])
}

model Topic {
  id                   String                 @id @default(cuid())
  title                String
  description          String?
  order                Int
  subject_id           String
  school_id            String
  academic_session_id  String
  is_active            Boolean                @default(true)
  created_by           String
  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt
  instructions         String?
  assessments          Assessment[]
  assignments          Assignment[]
  AssignmentSubmission AssignmentSubmission[]
  libraryResources     LibraryResource[]
  liveClasses          LiveClass[]
  pdfMaterial          PDFMaterial[]
  academicSession      AcademicSession        @relation(fields: [academic_session_id], references: [id])
  createdBy            User                   @relation("TopicCreator", fields: [created_by], references: [id])
  school               School                 @relation(fields: [school_id], references: [id])
  subject              Subject                @relation(fields: [subject_id], references: [id], onDelete: Cascade)
  videoContent         VideoContent[]

  @@unique([subject_id, title, academic_session_id])
  @@index([subject_id, order])
  @@index([school_id, academic_session_id])
  @@index([created_by])
}

model Finance {
  id               String    @id @default(cuid())
  school_id        String    @unique
  total_revenue    Float     @default(0)
  outstanding_fee  Float     @default(0)
  amount_withdrawn Float     @default(0)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  school           School    @relation(fields: [school_id], references: [id])
  payments         Payment[]
  Wallet           Wallet[]
}

model Payment {
  id                  String          @id @default(cuid())
  finance_id          String
  academic_session_id String
  student_id          String
  class_id            String
  payment_for         String
  amount              Float
  payment_type        PaymentType
  transaction_type    TransactionType
  payment_date        DateTime        @default(now())
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt
  academicSession     AcademicSession @relation(fields: [academic_session_id], references: [id])
  class               Class           @relation(fields: [class_id], references: [id])
  finance             Finance         @relation(fields: [finance_id], references: [id])
  student             User            @relation("StudentPayment", fields: [student_id], references: [id])
}

model TimetableEntry {
  id                  String          @id @default(cuid())
  class_id            String
  subject_id          String
  teacher_id          String
  school_id           String
  academic_session_id String
  timeSlotId          String
  day_of_week         DayOfWeek
  room                String?
  notes               String?
  isActive            Boolean         @default(true)
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt
  academicSession     AcademicSession @relation(fields: [academic_session_id], references: [id])
  class               Class           @relation(fields: [class_id], references: [id])
  school              School          @relation(fields: [school_id], references: [id])
  subject             Subject         @relation(fields: [subject_id], references: [id])
  teacher             Teacher         @relation("TeacherSchedule", fields: [teacher_id], references: [id])
  timeSlot            TimeSlot        @relation(fields: [timeSlotId], references: [id])

  @@unique([class_id, timeSlotId, day_of_week, academic_session_id])
  @@index([teacher_id, timeSlotId, day_of_week, academic_session_id])
  @@index([school_id, day_of_week, timeSlotId, academic_session_id])
}

model TimeSlot {
  id               String           @id @default(cuid())
  startTime        String
  endTime          String
  label            String
  order            Int
  schoolId         String
  isActive         Boolean          @default(true)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  school           School           @relation(fields: [schoolId], references: [id])
  timetableEntries TimetableEntry[]

  @@unique([startTime, endTime, schoolId])
  @@index([order])
  @@index([schoolId, startTime, endTime])
}

model Wallet {
  id           String              @id @default(cuid())
  school_id    String              @unique
  balance      Float               @default(0)
  currency     String              @default("NGN")
  wallet_type  WalletType          @default(SCHOOL_WALLET)
  is_active    Boolean             @default(true)
  last_updated DateTime            @default(now())
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  financeId    String?
  finance      Finance?            @relation(fields: [financeId], references: [id])
  school       School              @relation(fields: [school_id], references: [id])
  transactions WalletTransaction[]

  @@index([school_id])
  @@index([wallet_type])
}

model WalletTransaction {
  id               String                  @id @default(cuid())
  wallet_id        String
  transaction_type WalletTransactionType
  amount           Float
  description      String
  reference        String?                 @unique
  status           WalletTransactionStatus @default(PENDING)
  metadata         Json?
  processed_at     DateTime?
  createdAt        DateTime                @default(now())
  updatedAt        DateTime                @updatedAt
  wallet           Wallet                  @relation(fields: [wallet_id], references: [id])

  @@index([wallet_id])
  @@index([transaction_type])
  @@index([status])
  @@index([createdAt])
  @@index([reference])
}

model TeacherSubject {
  id        String  @id @default(cuid())
  teacherId String
  subjectId String
  subject   Subject @relation(fields: [subjectId], references: [id])
  teacher   Teacher @relation(fields: [teacherId], references: [id])

  @@unique([teacherId, subjectId])
}

model Notification {
  id                  String           @id @default(cuid())
  school_id           String
  academic_session_id String
  title               String
  description         String
  type                NotificationType
  comingUpOn          DateTime?
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
  academicSession     AcademicSession  @relation(fields: [academic_session_id], references: [id])
  school              School           @relation(fields: [school_id], references: [id])
}

model DeviceToken {
  id         String   @id @default(cuid())
  token      String   @unique
  deviceType String
  user_id    String
  school_id  String
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  school     School   @relation(fields: [school_id], references: [id])
  user       User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([school_id])
  @@index([token])
  @@index([isActive])
}

model StudentPerformance {
  id                  String          @id @default(cuid())
  student_id          String
  class_id            String
  academic_session_id String
  term                Int
  year                Int
  total_score         Float
  max_score           Float
  position            Int?
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt
  academicSession     AcademicSession @relation(fields: [academic_session_id], references: [id])
  class               Class           @relation(fields: [class_id], references: [id])
  student             User            @relation("StudentPerformance", fields: [student_id], references: [id])
}

model Result {
  id                       String          @id @default(cuid())
  school_id                String
  academic_session_id      String
  student_id               String
  class_id                 String?
  // Subject-wise results stored as JSON for flexibility
  // Structure: [{ subject_id, subject_code, subject_name, ca_score, exam_score, total_score, total_max_score, percentage, grade }]
  subject_results          Json
  // Overall statistics
  total_ca_score           Float           @default(0)
  total_exam_score         Float           @default(0)
  total_score              Float           @default(0)
  total_max_score          Float           @default(0)
  overall_percentage       Float           @default(0)
  overall_grade            String?
  class_position           Int?
  total_students           Int?
  // Metadata
  released_by              String? // User ID who released the results
  released_at              DateTime        @default(now())
  is_final                 Boolean         @default(true)
  released_by_school_admin Boolean         @default(false) // True if released by school director/admin
  createdAt                DateTime        @default(now())
  updatedAt                DateTime        @updatedAt
  academicSession          AcademicSession @relation(fields: [academic_session_id], references: [id])
  school                   School          @relation(fields: [school_id], references: [id])
  student                  Student         @relation(fields: [student_id], references: [id], onDelete: Cascade)
  class                    Class?          @relation(fields: [class_id], references: [id])
  releasedBy               User?           @relation("ResultReleasedBy", fields: [released_by], references: [id])

  @@unique([academic_session_id, student_id])
  @@index([school_id, academic_session_id])
  @@index([student_id])
  @@index([class_id])
  @@index([released_at])
}

model Organisation {
  id              String            @id @default(cuid())
  name            String            @unique
  email           String
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  libraryResource LibraryResource[]
  liveClass       LiveClass[]
  pdfMaterial     PDFMaterial[]
  schools         School[]
  videoContent    VideoContent[]
}

model VideoContent {
  id           String       @id @default(cuid())
  title        String
  description  String?
  url          String
  schoolId     String?
  platformId   String
  uploadedById String
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  topic_id     String?
  duration     String?
  size         String?
  status       String       @default("published")
  thumbnail    Json?
  views        Int          @default(0)
  order        Int          @default(0)
  platform     Organisation @relation(fields: [platformId], references: [id])
  school       School?      @relation(fields: [schoolId], references: [id])
  topic        Topic?       @relation(fields: [topic_id], references: [id])
  uploadedBy   User         @relation(fields: [uploadedById], references: [id])
  videoViews   SchoolVideoView[]
  watchHistory SchoolVideoWatchHistory[]

  @@index([schoolId])
  @@index([platformId])
  @@index([topic_id])
  @@index([status])
  @@index([createdAt])
}

model PDFMaterial {
  id                  String              @id @default(cuid())
  title               String
  description         String?
  url                 String
  schoolId            String?
  platformId          String
  uploadedById        String
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  topic_id            String?
  downloads           Int                 @default(0)
  size                String?
  status              String              @default("published")
  order               Int                 @default(1)
  fileType            String?
  originalName        String?
  materialId          String?             @unique @default(uuid())
  chatAnalytics       ChatAnalytics[]
  chatConversations   ChatConversation[]
  chatMessages        ChatMessage[]
  documentChunks      DocumentChunk[]
  materialProcessings MaterialProcessing?
  platform            Organisation        @relation(fields: [platformId], references: [id])
  school              School?             @relation(fields: [schoolId], references: [id])
  topic               Topic?              @relation(fields: [topic_id], references: [id])
  uploadedBy          User                @relation(fields: [uploadedById], references: [id])

  @@index([schoolId])
  @@index([platformId])
  @@index([topic_id])
  @@index([status])
  @@index([createdAt])
}

model Assignment {
  id                    String                 @id @default(cuid())
  title                 String
  description           String?
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  topic_id              String
  order                 Int                    @default(1)
  academic_session_id   String
  allow_late_submission Boolean                @default(false)
  assignment_type       AssignmentType         @default(HOMEWORK)
  attachment_type       String?
  attachment_url        String?
  auto_grade            Boolean                @default(false)
  created_by            String
  difficulty_level      DifficultyLevel        @default(MEDIUM)
  due_date              DateTime?
  grading_rubric_id     String?
  instructions          String?
  is_published          Boolean                @default(false)
  late_penalty          Float?
  max_score             Int                    @default(100)
  published_at          DateTime?
  school_id             String
  time_limit            Int?
  status                AssignmentStatus       @default(DRAFT)
  academicSession       AcademicSession        @relation(fields: [academic_session_id], references: [id])
  createdBy             User                   @relation(fields: [created_by], references: [id])
  gradingRubric         GradingRubric?         @relation(fields: [grading_rubric_id], references: [id])
  school                School                 @relation(fields: [school_id], references: [id])
  topic                 Topic                  @relation(fields: [topic_id], references: [id])
  grades                AssignmentGrade[]
  submissions           AssignmentSubmission[]

  @@index([school_id, academic_session_id])
  @@index([topic_id])
  @@index([created_by])
  @@index([due_date])
  @@index([status])
  @@index([is_published])
}

model Assessment {
  id                       String                 @id @default(cuid())
  title                    String
  description              String?
  duration                 Int?
  createdAt                DateTime               @default(now())
  updatedAt                DateTime               @updatedAt
  topic_id                 String?
  order                    Int                    @default(0)
  academic_session_id      String
  allow_review             Boolean                @default(true)
  auto_submit              Boolean                @default(false)
  created_by               String
  end_date                 DateTime?
  grading_type             GradingType            @default(AUTOMATIC)
  instructions             String?
  is_published             Boolean                @default(false)
  is_result_released       Boolean                @default(false)
  max_attempts             Int                    @default(1)
  passing_score            Float                  @default(50.0)
  published_at             DateTime?
  result_released_at       DateTime?
  school_id                String
  show_correct_answers     Boolean                @default(false)
  show_feedback            Boolean                @default(true)
  shuffle_options          Boolean                @default(false)
  shuffle_questions        Boolean                @default(false)
  start_date               DateTime?
  tags                     String[]
  time_limit               Int?
  total_points             Float                  @default(100.0)
  status                   QuizStatus             @default(DRAFT)
  subject_id               String
  assessment_type          AssessmentType         @default(CBT)
  submissions              Json?
  student_can_view_grading Boolean                @default(true)
  academicSession          AcademicSession        @relation(fields: [academic_session_id], references: [id])
  createdBy                User                   @relation(fields: [created_by], references: [id])
  school                   School                 @relation(fields: [school_id], references: [id])
  subject                  Subject                @relation(fields: [subject_id], references: [id], onDelete: Cascade)
  topic                    Topic?                 @relation(fields: [topic_id], references: [id])
  analytics                AssessmentAnalytics?
  attempts                 AssessmentAttempt[]
  questions                AssessmentQuestion[]
  assessmentSubmissions    AssessmentSubmission[]

  @@index([school_id, academic_session_id])
  @@index([topic_id])
  @@index([created_by])
  @@index([status])
  @@index([is_published])
  @@index([assessment_type])
  @@index([start_date, end_date])
}

model AssessmentQuestion {
  id                      String                    @id @default(cuid())
  assessment_id           String
  question_text           String
  question_type           QuestionType
  order                   Int
  points                  Float                     @default(1.0)
  is_required             Boolean                   @default(true)
  time_limit              Int?
  image_url               String?
  image_s3_key            String?
  audio_url               String?
  video_url               String?
  allow_multiple_attempts Boolean                   @default(false)
  show_hint               Boolean                   @default(false)
  hint_text               String?
  min_length              Int?
  max_length              Int?
  min_value               Float?
  max_value               Float?
  explanation             String?
  difficulty_level        DifficultyLevel           @default(MEDIUM)
  createdAt               DateTime                  @default(now())
  updatedAt               DateTime                  @updatedAt
  correct_answers         AssessmentCorrectAnswer[]
  options                 AssessmentOption[]
  assessment              Assessment                @relation(fields: [assessment_id], references: [id], onDelete: Cascade)
  responses               AssessmentResponse[]

  @@index([assessment_id, order])
  @@index([question_type])
}

model AssessmentOption {
  id          String               @id @default(cuid())
  question_id String
  option_text String
  order       Int
  is_correct  Boolean              @default(false)
  image_url   String?
  audio_url   String?
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  question    AssessmentQuestion   @relation(fields: [question_id], references: [id], onDelete: Cascade)
  responses   AssessmentResponse[] @relation("ResponseOptions")

  @@index([question_id, order])
}

model AssessmentCorrectAnswer {
  id            String             @id @default(cuid())
  question_id   String
  answer_text   String?
  answer_number Float?
  answer_date   DateTime?
  option_ids    String[]
  answer_json   Json?
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  question      AssessmentQuestion @relation(fields: [question_id], references: [id], onDelete: Cascade)

  @@index([question_id])
}

model AssessmentAttempt {
  id                  String               @id @default(cuid())
  assessment_id       String
  student_id          String
  school_id           String
  academic_session_id String
  attempt_number      Int                  @default(1)
  status              QuizAttemptStatus    @default(NOT_STARTED)
  started_at          DateTime?
  submitted_at        DateTime?
  time_spent          Int?
  total_score         Float                @default(0)
  max_score           Float
  percentage          Float                @default(0)
  passed              Boolean              @default(false)
  is_graded           Boolean              @default(false)
  graded_at           DateTime?
  graded_by           String?
  overall_feedback    String?
  grade_letter        String?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  academicSession     AcademicSession      @relation(fields: [academic_session_id], references: [id])
  assessment          Assessment           @relation(fields: [assessment_id], references: [id])
  grader              User?                @relation("AssessmentGrader", fields: [graded_by], references: [id])
  school              School               @relation(fields: [school_id], references: [id])
  student             User                 @relation(fields: [student_id], references: [id])
  responses           AssessmentResponse[]

  @@unique([assessment_id, student_id, attempt_number])
  @@index([assessment_id])
  @@index([student_id])
  @@index([status])
  @@index([submitted_at])
}

model AssessmentSubmission {
  id                  String           @id @default(cuid())
  assessment_id       String
  student_id          String
  school_id           String
  academic_session_id String
  submission_type     AssessmentType   @default(EXAM)
  content             String?
  attachment_url      String?
  attachment_type     String?
  status              SubmissionStatus @default(SUBMITTED)
  submitted_at        DateTime         @default(now())
  late_submission     Boolean          @default(false)
  word_count          Int?
  file_size           String?
  total_score         Float?
  max_score           Float?
  percentage          Float?
  passed              Boolean          @default(false)
  is_graded           Boolean          @default(false)
  graded_at           DateTime?
  graded_by           String?
  feedback            String?
  grade_letter        String?
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
  academicSession     AcademicSession  @relation(fields: [academic_session_id], references: [id])
  assessment          Assessment       @relation(fields: [assessment_id], references: [id], onDelete: Cascade)
  grader              User?            @relation("AssessmentGrader", fields: [graded_by], references: [id])
  school              School           @relation(fields: [school_id], references: [id])
  student             User             @relation(fields: [student_id], references: [id])

  @@unique([assessment_id, student_id])
  @@index([assessment_id])
  @@index([student_id])
  @@index([school_id, academic_session_id])
  @@index([submitted_at])
  @@index([status])
}

model AssessmentResponse {
  id               String             @id @default(cuid())
  attempt_id       String
  question_id      String
  student_id       String
  text_answer      String?
  numeric_answer   Float?
  date_answer      DateTime?
  selected_options String[]
  file_urls        String[]
  is_correct       Boolean?
  points_earned    Float              @default(0)
  max_points       Float
  time_spent       Int?
  feedback         String?
  is_graded        Boolean            @default(false)
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  attempt          AssessmentAttempt  @relation(fields: [attempt_id], references: [id], onDelete: Cascade)
  question         AssessmentQuestion @relation(fields: [question_id], references: [id])
  student          User               @relation(fields: [student_id], references: [id])
  selectedOptions  AssessmentOption[] @relation("ResponseOptions")

  @@unique([attempt_id, question_id])
  @@index([attempt_id])
  @@index([question_id])
  @@index([student_id])
}

model AssessmentAnalytics {
  id               String     @id @default(cuid())
  assessment_id    String     @unique
  total_attempts   Int        @default(0)
  total_students   Int        @default(0)
  average_score    Float      @default(0)
  average_time     Int        @default(0)
  pass_rate        Float      @default(0)
  question_stats   Json
  daily_attempts   Json
  hourly_attempts  Json
  completion_rate  Float      @default(0)
  abandonment_rate Float      @default(0)
  last_updated     DateTime   @default(now())
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt
  assessment       Assessment @relation(fields: [assessment_id], references: [id], onDelete: Cascade)

  @@index([assessment_id])
}

model LiveClass {
  id              String       @id @default(cuid())
  title           String
  description     String?
  meetingUrl      String
  startTime       DateTime
  endTime         DateTime
  schoolId        String?
  platformId      String
  createdById     String
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  topic_id        String?
  maxParticipants Int?
  status          String       @default("scheduled")
  order           Int          @default(0)
  createdBy       User         @relation(fields: [createdById], references: [id])
  platform        Organisation @relation(fields: [platformId], references: [id])
  school          School?      @relation(fields: [schoolId], references: [id])
  topic           Topic?       @relation(fields: [topic_id], references: [id])

  @@index([schoolId])
  @@index([platformId])
  @@index([topic_id])
  @@index([startTime])
  @@index([status])
  @@index([createdAt])
}

model LibraryResource {
  id           String       @id @default(cuid())
  title        String
  description  String?
  resourceType String
  url          String?
  schoolId     String?
  platformId   String
  uploadedById String
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  topic_id     String?
  format       String?
  status       String       @default("available")
  order        Int          @default(0)
  platform     Organisation @relation(fields: [platformId], references: [id])
  school       School?      @relation(fields: [schoolId], references: [id])
  topic        Topic?       @relation(fields: [topic_id], references: [id])
  uploadedBy   User         @relation(fields: [uploadedById], references: [id])

  @@index([schoolId])
  @@index([platformId])
  @@index([resourceType])
  @@index([topic_id])
  @@index([status])
  @@index([createdAt])
}

model GradingRubric {
  id                  String          @id @default(cuid())
  name                String
  description         String?
  school_id           String
  academic_session_id String
  created_by          String
  criteria            Json
  total_points        Float
  scale_type          RubricScale     @default(POINTS)
  is_template         Boolean         @default(false)
  is_active           Boolean         @default(true)
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt
  assignments         Assignment[]
  academicSession     AcademicSession @relation(fields: [academic_session_id], references: [id])
  createdBy           User            @relation(fields: [created_by], references: [id])
  school              School          @relation(fields: [school_id], references: [id])

  @@index([school_id, academic_session_id])
  @@index([created_by])
  @@index([is_template])
}

model AssignmentSubmission {
  id                  String           @id @default(cuid())
  assignment_id       String
  student_id          String
  school_id           String
  academic_session_id String
  content             String?
  attachment_url      String?
  attachment_type     String?
  status              SubmissionStatus @default(SUBMITTED)
  submitted_at        DateTime         @default(now())
  late_submission     Boolean          @default(false)
  word_count          Int?
  file_size           String?
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
  topicId             String?
  grades              AssignmentGrade?
  academicSession     AcademicSession  @relation(fields: [academic_session_id], references: [id])
  assignment          Assignment       @relation(fields: [assignment_id], references: [id], onDelete: Cascade)
  school              School           @relation(fields: [school_id], references: [id])
  student             User             @relation(fields: [student_id], references: [id])
  Topic               Topic?           @relation(fields: [topicId], references: [id])

  @@unique([assignment_id, student_id])
  @@index([assignment_id])
  @@index([student_id])
  @@index([school_id, academic_session_id])
  @@index([submitted_at])
}

model AssignmentGrade {
  id                  String               @id @default(cuid())
  assignment_id       String
  submission_id       String               @unique
  student_id          String
  teacher_id          String
  school_id           String
  academic_session_id String
  score               Float
  max_score           Float
  percentage          Float
  letter_grade        String?
  feedback            String?
  comments            String?
  rubric_scores       Json?
  status              GradeStatus          @default(PENDING)
  graded_at           DateTime?
  returned_at         DateTime?
  grading_time        Int?
  is_final            Boolean              @default(true)
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  academicSession     AcademicSession      @relation(fields: [academic_session_id], references: [id])
  assignment          Assignment           @relation(fields: [assignment_id], references: [id])
  school              School               @relation(fields: [school_id], references: [id])
  student             User                 @relation(fields: [student_id], references: [id])
  submission          AssignmentSubmission @relation(fields: [submission_id], references: [id])
  teacher             User                 @relation("AssignmentGradeGiver", fields: [teacher_id], references: [id])

  @@index([assignment_id])
  @@index([student_id])
  @@index([teacher_id])
  @@index([school_id, academic_session_id])
  @@index([graded_at])
}

model MaterialProcessing {
  id                      String                   @id @default(cuid())
  material_id             String                   @unique
  school_id               String
  status                  MaterialProcessingStatus @default(PENDING)
  total_chunks            Int                      @default(0)
  failed_chunks           Int                      @default(0)
  processing_started_at   DateTime?
  processing_completed_at DateTime?
  retry_count             Int                      @default(0)
  vector_database_id      String?
  embedding_model         String?
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt
  chunks                  DocumentChunk[]
  error_message           String?
  processed_chunks        Int                      @default(0)
  material                PDFMaterial              @relation(fields: [material_id], references: [id], onDelete: Cascade)
  school                  School                   @relation(fields: [school_id], references: [id])

  @@index([school_id])
  @@index([status])
  @@index([createdAt])
}

model DocumentChunk {
  id                     String                @id @default(cuid())
  material_processing_id String
  material_id            String
  school_id              String
  content                String
  chunk_type             ChunkType             @default(TEXT)
  page_number            Int?
  section_title          String?
  embedding              Unsupported("vector")
  embedding_model        String
  token_count            Int                   @default(0)
  word_count             Int                   @default(0)
  order_index            Int
  keywords               String[]              @default([])
  summary                String?
  createdAt              DateTime              @default(now())
  updatedAt              DateTime              @updatedAt
  chatContexts           ChatContext[]
  material               PDFMaterial           @relation(fields: [material_id], references: [id], onDelete: Cascade)
  materialProcessing     MaterialProcessing    @relation(fields: [material_processing_id], references: [id], onDelete: Cascade)
  school                 School                @relation(fields: [school_id], references: [id])

  @@index([material_id])
  @@index([school_id])
  @@index([chunk_type])
  @@index([page_number])
  @@index([order_index])
  @@index([createdAt])
}

model ChatConversation {
  id              String             @id @default(cuid())
  user_id         String
  school_id       String
  material_id     String?
  title           String?
  status          ConversationStatus @default(ACTIVE)
  system_prompt   String?
  context_summary String?
  total_messages  Int                @default(0)
  last_activity   DateTime           @default(now())
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  contexts        ChatContext[]
  material        PDFMaterial?       @relation(fields: [material_id], references: [id])
  school          School             @relation(fields: [school_id], references: [id])
  user            User               @relation(fields: [user_id], references: [id])
  messages        ChatMessage[]

  @@index([user_id])
  @@index([school_id])
  @@index([material_id])
  @@index([status])
  @@index([last_activity])
}

model ChatMessage {
  id                String            @id @default(cuid())
  conversation_id   String?
  user_id           String
  school_id         String
  material_id       String?
  role              MessageRole       @default(USER)
  content           String
  message_type      String            @default("TEXT")
  model_used        String?
  tokens_used       Int?
  response_time_ms  Int?
  context_chunks    String[]
  context_summary   String?
  is_edited         Boolean           @default(false)
  edited_at         DateTime?
  parent_message_id String?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  contexts          ChatContext[]
  conversation      ChatConversation? @relation(fields: [conversation_id], references: [id], onDelete: Cascade)
  material          PDFMaterial?      @relation(fields: [material_id], references: [id])
  school            School            @relation(fields: [school_id], references: [id])
  user              User              @relation(fields: [user_id], references: [id])

  @@index([conversation_id])
  @@index([user_id])
  @@index([school_id])
  @@index([material_id])
  @@index([role])
  @@index([createdAt])
}

model ChatContext {
  id                  String           @id @default(cuid())
  conversation_id     String
  message_id          String
  chunk_id            String
  school_id           String
  relevance_score     Float
  context_type        String           @default("semantic")
  position_in_context Int
  createdAt           DateTime         @default(now())
  chunk               DocumentChunk    @relation(fields: [chunk_id], references: [id], onDelete: Cascade)
  conversation        ChatConversation @relation(fields: [conversation_id], references: [id], onDelete: Cascade)
  message             ChatMessage      @relation(fields: [message_id], references: [id], onDelete: Cascade)
  school              School           @relation(fields: [school_id], references: [id])

  @@unique([message_id, chunk_id])
  @@index([conversation_id])
  @@index([message_id])
  @@index([chunk_id])
  @@index([school_id])
  @@index([relevance_score])
}

model ChatAnalytics {
  id                       String       @id @default(cuid())
  school_id                String
  material_id              String?
  user_id                  String?
  total_conversations      Int          @default(0)
  total_messages           Int          @default(0)
  total_tokens_used        Int          @default(0)
  average_response_time_ms Int          @default(0)
  average_relevance_score  Float        @default(0)
  most_used_chunks         String[]
  popular_questions        String[]
  date                     DateTime     @default(now())
  daily_usage              Int          @default(0)
  weekly_usage             Int          @default(0)
  monthly_usage            Int          @default(0)
  createdAt                DateTime     @default(now())
  updatedAt                DateTime     @updatedAt
  material                 PDFMaterial? @relation(fields: [material_id], references: [id])
  school                   School       @relation(fields: [school_id], references: [id])
  user                     User?        @relation(fields: [user_id], references: [id])

  @@index([school_id])
  @@index([material_id])
  @@index([user_id])
  @@index([date])
}

model AttendanceSession {
  id                  String                @id @default(cuid())
  school_id           String
  academic_session_id String
  class_id            String
  teacher_id          String
  date                DateTime
  session_type        AttendanceSessionType @default(DAILY)
  status              AttendanceStatus      @default(PENDING)
  total_students      Int                   @default(0)
  present_count       Int                   @default(0)
  absent_count        Int                   @default(0)
  late_count          Int                   @default(0)
  excused_count       Int                   @default(0)
  attendance_rate     Float                 @default(0.0)
  notes               String?
  submitted_at        DateTime?
  approved_at         DateTime?
  approved_by         String?
  created_at          DateTime              @default(now())
  updated_at          DateTime              @updatedAt
  records             AttendanceRecord[]
  academicSession     AcademicSession       @relation(fields: [academic_session_id], references: [id])
  approver            User?                 @relation("AttendanceApprover", fields: [approved_by], references: [id])
  class               Class                 @relation(fields: [class_id], references: [id])
  school              School                @relation(fields: [school_id], references: [id])
  teacher             Teacher               @relation(fields: [teacher_id], references: [id])

  @@unique([class_id, date, session_type])
  @@index([school_id, academic_session_id])
  @@index([class_id, date])
  @@index([teacher_id, date])
  @@index([status])
  @@index([date])
  @@index([attendance_rate])
}

model AttendanceRecord {
  id                    String                 @id @default(cuid())
  attendance_session_id String
  student_id            String
  school_id             String
  academic_session_id   String
  class_id              String
  status                AttendanceRecordStatus @default(ABSENT)
  marked_at             DateTime?
  marked_by             String?
  reason                String?
  is_excused            Boolean                @default(false)
  excuse_note           String?
  parent_notified       Boolean                @default(false)
  parent_notified_at    DateTime?
  created_at            DateTime               @default(now())
  updated_at            DateTime               @updatedAt
  academicSession       AcademicSession        @relation(fields: [academic_session_id], references: [id])
  attendanceSession     AttendanceSession      @relation(fields: [attendance_session_id], references: [id], onDelete: Cascade)
  class                 Class                  @relation(fields: [class_id], references: [id])
  marker                User?                  @relation("AttendanceMarker", fields: [marked_by], references: [id])
  school                School                 @relation(fields: [school_id], references: [id])
  student               User                   @relation(fields: [student_id], references: [id])

  @@unique([attendance_session_id, student_id])
  @@index([school_id, academic_session_id])
  @@index([class_id])
  @@index([student_id])
  @@index([status])
  @@index([marked_at])
}

model AttendanceSummary {
  id                  String               @id @default(cuid())
  school_id           String
  academic_session_id String
  class_id            String
  student_id          String?
  period_type         AttendancePeriodType
  period_start        DateTime
  period_end          DateTime
  total_days          Int                  @default(0)
  present_days        Int                  @default(0)
  absent_days         Int                  @default(0)
  late_days           Int                  @default(0)
  excused_days        Int                  @default(0)
  attendance_rate     Float                @default(0.0)
  created_at          DateTime             @default(now())
  updated_at          DateTime             @updatedAt
  academicSession     AcademicSession      @relation(fields: [academic_session_id], references: [id])
  class               Class                @relation(fields: [class_id], references: [id])
  school              School               @relation(fields: [school_id], references: [id])
  student             User?                @relation(fields: [student_id], references: [id])

  @@unique([school_id, academic_session_id, class_id, student_id, period_type, period_start])
  @@index([school_id, academic_session_id])
  @@index([class_id, period_type])
  @@index([student_id, period_type])
  @@index([period_start, period_end])
  @@index([attendance_rate])
}

model AttendanceSettings {
  id                          String          @id @default(cuid())
  school_id                   String          @unique
  academic_session_id         String
  late_threshold_minutes      Int             @default(15)
  auto_mark_absent_minutes    Int             @default(30)
  require_excuse_note         Boolean         @default(true)
  parent_notification_enabled Boolean         @default(true)
  attendance_tracking_enabled Boolean         @default(true)
  minimum_attendance_rate     Float           @default(75.0)
  max_consecutive_absences    Int             @default(5)
  created_at                  DateTime        @default(now())
  updated_at                  DateTime        @updatedAt
  academicSession             AcademicSession @relation(fields: [academic_session_id], references: [id])
  school                      School          @relation(fields: [school_id], references: [id])

  @@index([school_id, academic_session_id])
}

model UserSettings {
  id                         String   @id @default(cuid())
  user_id                    String   @unique
  school_id                  String
  push_notifications         Boolean  @default(true)
  email_notifications        Boolean  @default(true)
  assessment_reminders       Boolean  @default(true)
  grade_notifications        Boolean  @default(true)
  announcement_notifications Boolean  @default(false)
  dark_mode                  Boolean  @default(false)
  sound_effects              Boolean  @default(true)
  haptic_feedback            Boolean  @default(true)
  auto_save                  Boolean  @default(true)
  offline_mode               Boolean  @default(false)
  profile_visibility         String   @default("classmates")
  show_contact_info          Boolean  @default(true)
  show_academic_progress     Boolean  @default(true)
  data_sharing               Boolean  @default(false)
  createdAt                  DateTime @default(now())
  updatedAt                  DateTime @updatedAt
  school                     School   @relation(fields: [school_id], references: [id])
  user                       User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([school_id])
}

model Achievement {
  id                  String               @id @default(cuid())
  school_id           String
  academic_session_id String
  title               String
  description         String
  type                AchievementType
  icon_url            String?
  points              Int                  @default(0)
  is_active           Boolean              @default(true)
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  academicSession     AcademicSession      @relation(fields: [academic_session_id], references: [id])
  school              School               @relation(fields: [school_id], references: [id])
  studentAchievements StudentAchievement[]

  @@index([school_id])
  @@index([academic_session_id])
  @@index([type])
}

model StudentAchievement {
  id             String      @id @default(cuid())
  student_id     String
  achievement_id String
  earned_date    DateTime    @default(now())
  points_earned  Int         @default(0)
  is_visible     Boolean     @default(true)
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  achievement    Achievement @relation(fields: [achievement_id], references: [id])
  student        User        @relation("StudentAchievements", fields: [student_id], references: [id], onDelete: Cascade)

  @@unique([student_id, achievement_id])
  @@index([student_id])
  @@index([achievement_id])
}

model SupportInfo {
  id                      String    @id @default(cuid())
  school_id               String    @unique
  faq_count               Int       @default(0)
  last_faq_update         DateTime?
  faq_categories          Json      @default("[]")
  email_support           String    @default("support@school.edu")
  phone_support           String    @default("+1-800-SCHOOL")
  live_chat_available     Boolean   @default(false)
  response_time           String    @default("24 hours")
  app_version             String    @default("1.0.0")
  build_number            String    @default("100")
  last_updated            DateTime  @default(now())
  minimum_ios_version     String    @default("13.0")
  minimum_android_version String    @default("8.0")
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  school                  School    @relation(fields: [school_id], references: [id])

  @@index([school_id])
}

model PlatformSubscriptionPlan {
  id                                       String               @id @default(cuid())
  school_id                                String?              @unique
  name                                     String               @default("Free")
  plan_type                                SubscriptionPlanType @default(FREE)
  description                              String?
  cost                                     Float                @default(0)
  currency                                 String               @default("USD")
  billing_cycle                            BillingCycle         @default(MONTHLY)
  is_active                                Boolean              @default(true)
  max_allowed_teachers                     Int                  @default(30)
  max_allowed_students                     Int                  @default(100)
  max_allowed_classes                      Int?
  max_allowed_subjects                     Int?
  allowed_document_types                   String[]             @default(["pdf"])
  max_file_size_mb                         Int                  @default(10)
  max_document_uploads_per_student_per_day Int                  @default(3)
  max_document_uploads_per_teacher_per_day Int                  @default(10)
  max_storage_mb                           Int                  @default(500)
  max_files_per_month                      Int                  @default(10)
  max_daily_tokens_per_user                Int                  @default(50000)
  max_weekly_tokens_per_user               Int?
  max_monthly_tokens_per_user              Int?
  max_total_tokens_per_school              Int?
  max_messages_per_week                    Int                  @default(100)
  max_conversations_per_user               Int?
  max_chat_sessions_per_user               Int?
  features                                 Json?
  start_date                               DateTime?
  end_date                                 DateTime?
  status                                   SubscriptionStatus   @default(ACTIVE)
  auto_renew                               Boolean              @default(false)
  created_at                               DateTime             @default(now())
  updated_at                               DateTime             @updatedAt
  is_template                              Boolean              @default(false)
  school                                   School?              @relation(fields: [school_id], references: [id], onDelete: Cascade)

  @@index([school_id])
  @@index([plan_type])
  @@index([status])
  @@index([is_active])
  @@index([is_template])
}

enum SchoolType {
  primary
  secondary
  primary_and_secondary
}

enum SchoolOwnership {
  government
  private
}

enum SchoolStatus {
  not_verified
  pending
  approved
  rejected
  failed
  suspended
  closed
  archived
}

enum PaymentType {
  full
  partial
}

enum TransactionType {
  credit
  debit
}

enum NotificationType {
  all
  teachers
  students
  school_director
  admin
}

enum Gender {
  male
  female
  other
}

enum AcademicTerm {
  first
  second
  third
}

enum AcademicSessionStatus {
  active
  inactive
  completed
}

enum Roles {
  student
  teacher
  school_director
  school_admin
  parent
  super_admin
  ict_staff
}

enum UserStatus {
  active
  suspended
  inactive
}

enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

enum WalletTransactionType {
  CREDIT
  DEBIT
  TRANSFER
  WITHDRAWAL
  REFUND
  FEE_PAYMENT
  SCHOLARSHIP
  GRANT
  DONATION
}

enum WalletTransactionStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
  REVERSED
}

enum WalletType {
  SCHOOL_WALLET
  STUDENT_WALLET
  TEACHER_WALLET
}

enum MessageRole {
  USER
  ASSISTANT
  SYSTEM
}

enum ConversationStatus {
  ACTIVE
  PAUSED
  ENDED
  ARCHIVED
}

enum MaterialProcessingStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  RETRYING
}

enum ChunkType {
  TEXT
  HEADING
  PARAGRAPH
  LIST
  TABLE
  IMAGE_CAPTION
  FOOTNOTE
}

enum PurchaseStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
}

enum QuestionType {
  MULTIPLE_CHOICE_SINGLE
  MULTIPLE_CHOICE_MULTIPLE
  SHORT_ANSWER
  LONG_ANSWER
  TRUE_FALSE
  FILL_IN_BLANK
  MATCHING
  ORDERING
  FILE_UPLOAD
  NUMERIC
  DATE
  RATING_SCALE
}

enum QuizStatus {
  DRAFT
  PUBLISHED
  ACTIVE
  CLOSED
  ARCHIVED
}

enum QuizAttemptStatus {
  NOT_STARTED
  IN_PROGRESS
  SUBMITTED
  GRADED
  EXPIRED
}

enum GradingType {
  AUTOMATIC
  MANUAL
  MIXED
}

enum AssessmentType {
  FORMATIVE
  SUMMATIVE
  DIAGNOSTIC
  BENCHMARK
  PRACTICE
  MOCK_EXAM
  QUIZ
  TEST
  EXAM
  ASSIGNMENT
  CBT
  OTHER
}

enum AssignmentType {
  HOMEWORK
  PROJECT
  ESSAY
  RESEARCH
  PRACTICAL
  PRESENTATION
}

enum DifficultyLevel {
  EASY
  MEDIUM
  HARD
  EXPERT
}

enum AssignmentStatus {
  DRAFT
  PUBLISHED
  ACTIVE
  CLOSED
  ARCHIVED
}

enum SubmissionStatus {
  DRAFT
  SUBMITTED
  GRADED
  RETURNED
  RESUBMITTED
}

enum GradeStatus {
  PENDING
  GRADED
  RETURNED
  DISPUTED
  FINAL
}

enum RubricScale {
  POINTS
  PERCENTAGE
  LETTER_GRADE
  CUSTOM
}

enum AttendanceSessionType {
  DAILY
  MORNING
  AFTERNOON
  EVENING
  SPECIAL
}

enum AttendanceStatus {
  PENDING
  SUBMITTED
  APPROVED
  REJECTED
  CANCELLED
}

enum AttendanceRecordStatus {
  PRESENT
  ABSENT
  LATE
  EXCUSED
  PARTIAL
}

enum AttendancePeriodType {
  DAILY
  WEEKLY
  MONTHLY
  TERM
  YEARLY
}

enum AchievementType {
  ACADEMIC
  ATTENDANCE
  SPORTS
  EXTRACURRICULAR
  BEHAVIOR
  LEADERSHIP
  OTHER
}

enum SubscriptionPlanType {
  FREE
  BASIC
  PREMIUM
  ENTERPRISE
  CUSTOM
}

enum BillingCycle {
  MONTHLY
  QUARTERLY
  YEARLY
  ONE_TIME
}

enum SubscriptionStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  EXPIRED
  CANCELLED
  TRIAL
}

// ===================================================================
// Developer identity (for Smart Edu Hub internal developers)
// ===================================================================

model Developer {
  id        String   @id @default(cuid())
  name      String
  email     String   @unique
  password  String
  role      String   @default("developer")
  note      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ===================================================================
// Public Library domain (moved from prisma/library.prisma so that
// Prisma Client can see these models without multi-file config)
// ===================================================================

enum LibraryPlatformStatus {
  active
  inactive
  archived
}

enum ExamBodyStatus {
  active
  inactive
  archived
}

enum LibraryUserRole {
  admin
  manager
  content_creator
  reviewer
  viewer
}

enum LibraryUserType {
  libraryresourceowner
  librarymanager
  contentcreator
  reviewer
  viewer
}

enum LibraryContentStatus {
  draft
  published
  archived
}

enum ChapterStatus {
  active
  deleted
}

enum LibraryMaterialType {
  PDF
  DOC
  PPT
  VIDEO
  NOTE
  LINK
  OTHER
}

enum LibraryAssignmentType {
  HOMEWORK
  PROJECT
  ESSAY
  QUIZ
  PRACTICAL
  OTHER
}

enum LibraryAssignmentStatus {
  DRAFT
  PUBLISHED
  CLOSED
  ARCHIVED
}

// -------------------------------------------------------------------
// Core platform-level library models
// -------------------------------------------------------------------

/// Represents a public content library owned/managed by Smart Edu Hub.
/// Examples:
/// - Smart Edu Library
/// - Accessible Publishers Library
/// - Best Tech Academy Library
/// - Access Study Library
model LibraryPlatform {
  id          String                @id @default(cuid())
  name        String                @unique
  slug        String                @unique
  description String?
  status      LibraryPlatformStatus @default(active)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users                            LibraryResourceUser[]
  subjects                         LibrarySubject[]
  topics                           LibraryTopic[]
  videos                           LibraryVideoLesson[]
  materials                        LibraryMaterial[]
  assignments                      LibraryAssignment[]
  links                            LibraryLink[]
  comments                         LibraryComment[]
  generalMaterials                 LibraryGeneralMaterial[]
  generalMaterialPurchases         LibraryGeneralMaterialPurchase[]
  generalMaterialChatConversations LibraryGeneralMaterialChatConversation[]
  generalMaterialChapters          LibraryGeneralMaterialChapter[]
  generalMaterialChapterFiles      LibraryGeneralMaterialChapterFile[]
  generalMaterialProcessings       LibraryGeneralMaterialProcessing[]
  generalMaterialChunks            LibraryGeneralMaterialChunk[]
  assessments                      LibraryAssessment[]
}

/// Nigerian Examination Bodies (WAEC, JAMB, NECO, etc.)
/// These bodies can create assessments/past questions for students
model ExamBody {
  id          String         @id @default(cuid())
  name        String         @unique // e.g., "WAEC", "JAMB", "NECO"
  fullName    String // e.g., "West African Examinations Council"
  code        String         @unique // e.g., "WAEC", "JAMB"
  description String?
  logoUrl     String? // Optional logo for the exam body
  websiteUrl  String? // Official website
  status      ExamBodyStatus @default(active)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  subjects    ExamBodySubject[]
  years       ExamBodyYear[]
  assessments ExamBodyAssessment[]
}

/// Subjects under an exam body (e.g., WAEC Mathematics, JAMB English)
model ExamBodySubject {
  id          String         @id @default(cuid())
  examBodyId  String
  name        String // e.g., "Mathematics", "English Language"
  code        String // e.g., "MATH", "ENG"
  description String?
  iconUrl     String? // Optional icon for the subject
  order       Int            @default(0)
  status      ExamBodyStatus @default(active)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  examBody    ExamBody             @relation(fields: [examBodyId], references: [id], onDelete: Cascade)
  assessments ExamBodyAssessment[]

  @@unique([examBodyId, code])
  @@index([examBodyId])
  @@index([status])
}

/// Academic years for exam body past questions (e.g., "2024/2025", "2022/2023")
model ExamBodyYear {
  id          String         @id @default(cuid())
  examBodyId  String
  year        String // e.g., "2024/2025", "2022/2023"
  description String? // e.g., "First Session", "Second Session"
  startDate   DateTime? // Optional start date of exam period
  endDate     DateTime? // Optional end date of exam period
  order       Int            @default(0) // For sorting (most recent first)
  status      ExamBodyStatus @default(active)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  examBody    ExamBody             @relation(fields: [examBodyId], references: [id], onDelete: Cascade)
  assessments ExamBodyAssessment[]

  @@unique([examBodyId, year])
  @@index([examBodyId])
  @@index([status])
}

/// Past question assessments for exam bodies
model ExamBodyAssessment {
  id           String  @id @default(cuid())
  examBodyId   String
  subjectId    String
  yearId       String
  title        String // e.g., "WAEC Mathematics 2024/2025"
  description  String?
  instructions String? @db.Text

  // Assessment settings
  assessmentType AssessmentType @default(CBT)
  duration       Int? // Duration in minutes
  totalPoints    Float          @default(0)
  passingScore   Float          @default(50) // Percentage

  // Attempt settings
  maxAttempts      Int     @default(999) // Users can take many times
  allowReview      Boolean @default(true)
  shuffleQuestions Boolean @default(true)
  shuffleOptions   Boolean @default(true)

  // Display settings
  showCorrectAnswers Boolean @default(true)
  showFeedback       Boolean @default(true)
  showExplanation    Boolean @default(true)

  // Status
  status      ExamBodyStatus @default(active)
  isPublished Boolean        @default(false)
  publishedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  examBody  ExamBody                     @relation(fields: [examBodyId], references: [id], onDelete: Cascade)
  subject   ExamBodySubject              @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  year      ExamBodyYear                 @relation(fields: [yearId], references: [id], onDelete: Cascade)
  questions ExamBodyAssessmentQuestion[]
  attempts  ExamBodyAssessmentAttempt[]

  @@unique([examBodyId, subjectId, yearId])
  @@index([examBodyId])
  @@index([subjectId])
  @@index([yearId])
  @@index([status])
  @@index([isPublished])
}

/// Questions for exam body assessments
model ExamBodyAssessmentQuestion {
  id           String       @id @default(cuid())
  assessmentId String
  questionText String       @db.Text
  questionType QuestionType @default(MULTIPLE_CHOICE_SINGLE)

  // Media attachments
  imageUrl String?
  audioUrl String?
  videoUrl String?

  // Settings
  points      Float   @default(1)
  order       Int     @default(0)
  isRequired  Boolean @default(true)
  explanation String? @db.Text // Explanation for the correct answer

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  assessment     ExamBodyAssessment                @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  options        ExamBodyAssessmentOption[]
  correctAnswers ExamBodyAssessmentCorrectAnswer[]
  responses      ExamBodyAssessmentResponse[]

  @@index([assessmentId])
  @@index([questionType])
}

/// Options for exam body assessment questions
model ExamBodyAssessmentOption {
  id         String  @id @default(cuid())
  questionId String
  optionText String  @db.Text
  order      Int     @default(0)
  isCorrect  Boolean @default(false) // For auto-generating correct answers

  // Media attachments
  imageUrl String?
  audioUrl String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  question ExamBodyAssessmentQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@index([questionId])
}

/// Correct answers for exam body assessment questions
model ExamBodyAssessmentCorrectAnswer {
  id         String @id @default(cuid())
  questionId String

  // Different answer types
  answerText   String? // For short answer, fill in blank
  answerNumber Float? // For numeric questions
  answerDate   DateTime? // For date questions
  optionIds    String[] // For multiple choice (array of option IDs)
  answerJson   Json? // For complex answers (matching, ordering, etc.)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  question ExamBodyAssessmentQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@index([questionId])
}

/// User attempts for exam body assessments
model ExamBodyAssessmentAttempt {
  id            String            @id @default(cuid())
  assessmentId  String
  userId        String // From main User model
  attemptNumber Int               @default(1)
  status        QuizAttemptStatus @default(IN_PROGRESS)

  // Timing
  startedAt   DateTime?
  submittedAt DateTime?
  timeSpent   Int? // Time spent in seconds

  // Scoring
  totalScore Float   @default(0)
  maxScore   Float   @default(0)
  percentage Float   @default(0)
  passed     Boolean @default(false)

  // Grading
  isGraded Boolean   @default(false)
  gradedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  assessment ExamBodyAssessment           @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  user       User                         @relation(fields: [userId], references: [id], onDelete: Cascade)
  responses  ExamBodyAssessmentResponse[]

  @@unique([assessmentId, userId, attemptNumber])
  @@index([assessmentId])
  @@index([userId])
  @@index([status])
}

/// User responses for exam body assessment questions
model ExamBodyAssessmentResponse {
  id         String @id @default(cuid())
  attemptId  String
  questionId String
  userId     String // From main User model

  // Answer data (flexible for different question types)
  textAnswer      String? // For short/long answer
  numericAnswer   Float? // For numeric questions
  dateAnswer      DateTime? // For date questions
  selectedOptions String[] // For multiple choice (array of option IDs)
  fileUrls        String[] // For file upload questions
  answerJson      Json? // For complex answers

  // Grading
  isCorrect    Boolean? // null if not graded yet
  pointsEarned Float    @default(0)
  maxPoints    Float    @default(0)
  feedback     String?  @db.Text
  isGraded     Boolean  @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  attempt  ExamBodyAssessmentAttempt  @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  question ExamBodyAssessmentQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
  user     User                       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([attemptId, questionId])
  @@index([attemptId])
  @@index([questionId])
  @@index([userId])
}

/// Users who belong to a LibraryPlatform (e.g. content team members,
/// admins, reviewers). This is separate from the existing `User` model
/// to keep the public library domain isolated.
model LibraryResourceUser {
  id         String @id @default(cuid())
  platformId String

  email        String  @unique
  password     String
  first_name   String
  last_name    String
  phone_number String?

  role     LibraryUserRole @default(content_creator)
  userType LibraryUserType @default(libraryresourceowner)
  status   UserStatus      @default(active) // Reuses existing enum from main schema

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  platform                 LibraryPlatform                     @relation(fields: [platformId], references: [id])
  uploadedVideos           LibraryVideoLesson[]
  uploadedMaterials        LibraryMaterial[]
  uploadedAssignments      LibraryAssignment[]
  uploadedLinks            LibraryLink[]
  comments                 LibraryComment[]
  uploadedGeneralMaterials LibraryGeneralMaterial[]
  uploadedChapterFiles     LibraryGeneralMaterialChapterFile[]
  createdAssessments       LibraryAssessment[]
  videoViews               LibraryVideoView[]
  videoWatchHistory        LibraryVideoWatchHistory[]

  @@index([platformId])
}

// -------------------------------------------------------------------
// Academic-like structure within each public library
// -------------------------------------------------------------------

/// High-level grouping (e.g. "JSS 1", "JSS 2", "SS 1 Science Track")
model LibraryClass {
  id String @id @default(cuid())

  name  String
  order Int    @default(1)

  createdAt        DateTime                        @default(now())
  updatedAt        DateTime                        @updatedAt
  subjects         LibrarySubject[]
  materialClasses  LibraryGeneralMaterialClass[] // Many-to-many relationship with LibraryGeneralMaterial
}

/// Subjects under a library class (e.g. "Mathematics", "Physics").
model LibrarySubject {
  id         String  @id @default(cuid())
  platformId String
  classId    String?

  name        String
  code        String?
  color       String  @default("#3B82F6")
  description String?

  thumbnailUrl String?
  thumbnailKey String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  platform         LibraryPlatform          @relation(fields: [platformId], references: [id])
  class            LibraryClass?            @relation(fields: [classId], references: [id])
  topics           LibraryTopic[]
  videos           LibraryVideoLesson[]
  materials        LibraryMaterial[]
  assignments      LibraryAssignment[]
  links            LibraryLink[]
  comments         LibraryComment[]
  generalMaterials LibraryGeneralMaterial[]
  assessments      LibraryAssessment[]

  @@unique([platformId, code])
  @@index([platformId, name])
}

/// Topics within a library subject (e.g. "Introduction to Algebra").
/// Topics are directly under subjects, matching the teacher structure (Subject  Topic  Content).
model LibraryTopic {
  id         String @id @default(cuid())
  platformId String
  subjectId  String

  title       String
  description String?
  order       Int     @default(1)
  is_active   Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  platform LibraryPlatform @relation(fields: [platformId], references: [id])
  subject  LibrarySubject  @relation(fields: [subjectId], references: [id])

  videos      LibraryVideoLesson[]
  materials   LibraryMaterial[]
  assignments LibraryAssignment[]
  links       LibraryLink[]
  comments    LibraryComment[]
  assessments LibraryAssessment[]

  @@index([platformId, subjectId])
  @@index([subjectId, order])
}

// -------------------------------------------------------------------
// Content models: video lessons & study materials
// -------------------------------------------------------------------

/// High-quality video lessons produced by the library teams.
/// Actual video files are expected to live in S3; this model stores
/// URLs/keys/metadata only.
model LibraryVideoLesson {
  id           String  @id @default(cuid())
  platformId   String
  subjectId    String
  topicId      String?
  uploadedById String // Tracks which library user uploaded this video

  title       String
  description String?

  videoUrl       String // Public or signed URL
  videoS3Key     String? // S3 object key
  thumbnailUrl   String?
  thumbnailS3Key String?

  durationSeconds Int?
  sizeBytes       Int?
  views           Int  @default(0)

  status LibraryContentStatus @default(published)
  order  Int                  @default(1)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  platform     LibraryPlatform            @relation(fields: [platformId], references: [id])
  subject      LibrarySubject             @relation(fields: [subjectId], references: [id])
  topic        LibraryTopic?              @relation(fields: [topicId], references: [id])
  uploadedBy   LibraryResourceUser        @relation(fields: [uploadedById], references: [id])
  videoViews   LibraryVideoView[]
  watchHistory LibraryVideoWatchHistory[]

  @@index([platformId])
  @@index([subjectId])
  @@index([topicId])
  @@index([uploadedById])
  @@index([status])
}

/// Track unique video views per user (like YouTube view counter)
/// Ensures each user is counted only once per video for view count display
/// This is for quick metrics like "1.2M views" - NOT for watch history
model LibraryVideoView {
  id      String @id @default(cuid())
  videoId String

  // Polymorphic user reference - only ONE should be set
  userId                String? // Regular User (student/teacher)
  libraryResourceUserId String? // Library content creator/admin

  viewedAt DateTime @default(now())

  video               LibraryVideoLesson   @relation(fields: [videoId], references: [id], onDelete: Cascade)
  user                User?                @relation(fields: [userId], references: [id], onDelete: Cascade)
  libraryResourceUser LibraryResourceUser? @relation(fields: [libraryResourceUserId], references: [id], onDelete: Cascade)

  @@unique([videoId, userId, libraryResourceUserId])
  @@index([videoId])
  @@index([userId])
  @@index([libraryResourceUserId])
  @@index([viewedAt])
}

/// Complete watch history tracking (like YouTube watch history)
/// Tracks every watch event with detailed metadata for analytics and user history
model LibraryVideoWatchHistory {
  id      String @id @default(cuid())
  videoId String

  // Polymorphic user reference - only ONE should be set
  userId                String? // Regular User (student/teacher)
  libraryResourceUserId String? // Library content creator/admin

  // User context (for analytics)
  schoolId String? // Which school the user belongs to
  classId  String? // Which class the student is in (if applicable)
  userRole String? // Role: student, teacher, school_director, libraryresourceowner, etc.

  // Watch session metadata
  watchedAt            DateTime @default(now())
  watchDurationSeconds Int? // How long they actually watched (in seconds)
  videoDurationSeconds Int? // Total video duration at time of watch
  completionPercentage Float?   @default(0) // 0-100, calculated as (watchDuration / videoDuration) * 100

  // Engagement tracking
  isCompleted       Boolean @default(false) // True if watched > 90% of video
  lastWatchPosition Int?    @default(0) // Last position in seconds (for resume functionality)
  watchCount        Int     @default(1) // Number of times watched in this session

  // Device & Platform info
  deviceType String? // mobile, tablet, desktop, tv
  platform   String? // ios, android, web
  userAgent  String? // Browser/app user agent
  ipAddress  String? // For geo-analytics (optional, privacy consideration)

  // Source tracking (how they arrived at the video)
  referrerSource String? // direct, search, recommendation, related_video, playlist, etc.
  referrerUrl    String? // Previous page URL

  // Quality metrics
  videoQuality    String? // 360p, 480p, 720p, 1080p, etc.
  bufferingEvents Int?    @default(0) // Number of buffering interruptions
  playbackSpeed   Float?  @default(1.0) // 0.5x, 1x, 1.25x, 1.5x, 2x

  // Session tracking
  sessionId String? // Group multiple watches in same session

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  video               LibraryVideoLesson   @relation(fields: [videoId], references: [id], onDelete: Cascade)
  user                User?                @relation(fields: [userId], references: [id], onDelete: Cascade)
  libraryResourceUser LibraryResourceUser? @relation(fields: [libraryResourceUserId], references: [id], onDelete: Cascade)

  @@index([videoId]) // Query: "Who watched this video?"
  @@index([userId]) // Query: "What did this user watch?"
  @@index([libraryResourceUserId]) // Query: "What did this library user watch?"
  @@index([schoolId]) // Query: "Watch history by school"
  @@index([classId]) // Query: "Watch history by class"
  @@index([watchedAt]) // Query: "Recent watches"
  @@index([isCompleted]) // Query: "Completed videos"
  @@index([completionPercentage]) // Query: "Videos with high/low completion"
  @@index([sessionId]) // Query: "Group watches by session"
  @@index([videoId, userId]) // Query: "This user's watches of this video"
  @@index([videoId, schoolId]) // Query: "School's watches of this video"
  @@index([userId, watchedAt]) // Query: "User's watch history chronologically"
}

/// Track unique video views for school videos (VideoContent)
/// Ensures each user is counted only once per video (YouTube-style)
model SchoolVideoView {
  id      String @id @default(cuid())
  videoId String
  userId  String

  viewedAt DateTime @default(now())

  video VideoContent @relation(fields: [videoId], references: [id], onDelete: Cascade)
  user  User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([videoId, userId])
  @@index([videoId])
  @@index([userId])
  @@index([viewedAt])
}

/// Complete watch history tracking for school videos (VideoContent)
/// Tracks every watch event with detailed metadata for analytics and resume functionality
model SchoolVideoWatchHistory {
  id      String @id @default(cuid())
  videoId String
  userId  String

  // User context (for analytics)
  schoolId String? // Which school the user belongs to
  classId  String? // Which class the student is in (if applicable)
  userRole String? // Role: student, teacher, school_director

  // Watch session metadata
  watchedAt            DateTime @default(now())
  watchDurationSeconds Int? // How long they actually watched (in seconds)
  videoDurationSeconds Int? // Total video duration at time of watch
  completionPercentage Float?   @default(0) // 0-100, calculated as (watchDuration / videoDuration) * 100

  // Engagement tracking
  isCompleted       Boolean @default(false) // True if watched > 90% of video
  lastWatchPosition Int?    @default(0) // Last position in seconds (for resume functionality)
  watchCount        Int     @default(1) // Number of times watched in this session

  // Device & Platform info
  deviceType String? // mobile, tablet, desktop, tv
  platform   String? // ios, android, web
  userAgent  String? // Browser/app user agent

  // Source tracking (how they arrived at the video)
  referrerSource String? // direct, search, recommendation, related_video, playlist, etc.
  referrerUrl    String? // Previous page URL

  // Quality metrics
  videoQuality    String? // 360p, 480p, 720p, 1080p, etc.
  bufferingEvents Int?    @default(0) // Number of buffering interruptions
  playbackSpeed   Float?  @default(1.0) // 0.5x, 1x, 1.25x, 1.5x, 2x

  // Session tracking
  sessionId String? // Group multiple watches in same session

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  video VideoContent @relation(fields: [videoId], references: [id], onDelete: Cascade)
  user  User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([videoId]) // Query: "Who watched this video?"
  @@index([userId]) // Query: "What did this user watch?"
  @@index([schoolId]) // Query: "Watch history by school"
  @@index([classId]) // Query: "Watch history by class"
  @@index([watchedAt]) // Query: "Recent watches"
  @@index([isCompleted]) // Query: "Completed videos"
  @@index([completionPercentage]) // Query: "Videos with high/low completion"
  @@index([sessionId]) // Query: "Group watches by session"
  @@index([videoId, userId]) // Query: "This user's watches of this video"
  @@index([videoId, schoolId]) // Query: "School's watches of this video"
  @@index([userId, watchedAt]) // Query: "User's watch history chronologically"
}

/// Comments on library content (subjects or topics).
/// Users/students can leave comments and replies on library content.
model LibraryComment {
  id         String @id @default(cuid())
  platformId String

  // Polymorphic relation - comment can be on subject or topic
  // Only one of these should be set
  subjectId String?
  topicId   String?

  // User who made the comment (can be LibraryResourceUser or regular User/Student)
  // For library users, use commentedById
  // For regular users/students, use userId
  commentedById String? // LibraryResourceUser ID
  userId        String? // Regular User ID (for students)

  content String // Comment text content

  // Support for nested comments (replies)
  parentCommentId String? // If this is a reply to another comment
  parentComment   LibraryComment?  @relation("CommentReplies", fields: [parentCommentId], references: [id])
  replies         LibraryComment[] @relation("CommentReplies")

  // Edit tracking
  isEdited Boolean   @default(false)
  editedAt DateTime?

  // Moderation
  isDeleted Boolean   @default(false)
  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  platform    LibraryPlatform      @relation(fields: [platformId], references: [id])
  subject     LibrarySubject?      @relation(fields: [subjectId], references: [id])
  topic       LibraryTopic?        @relation(fields: [topicId], references: [id])
  commentedBy LibraryResourceUser? @relation(fields: [commentedById], references: [id])
  user        User?                @relation(fields: [userId], references: [id])

  @@index([platformId])
  @@index([subjectId])
  @@index([topicId])
  @@index([commentedById])
  @@index([userId])
  @@index([parentCommentId])
  @@index([createdAt])
  @@index([isDeleted])
}

/// Assignments under each topic in a library.
/// These are assignments that students can complete as part of the library content.
model LibraryAssignment {
  id           String @id @default(cuid())
  platformId   String
  subjectId    String
  topicId      String // Required - assignments must be under a topic
  uploadedById String // Tracks which library user created this assignment

  title       String
  description String?

  assignmentType  LibraryAssignmentType @default(HOMEWORK)
  instructions    String?
  attachmentUrl   String? // URL to assignment file/document
  attachmentS3Key String? // S3 object key for assignment file

  dueDate             DateTime?
  maxScore            Int       @default(100)
  allowLateSubmission Boolean   @default(false)
  latePenalty         Float?

  status LibraryAssignmentStatus @default(DRAFT)
  order  Int                     @default(1)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  platform   LibraryPlatform     @relation(fields: [platformId], references: [id])
  subject    LibrarySubject      @relation(fields: [subjectId], references: [id])
  topic      LibraryTopic        @relation(fields: [topicId], references: [id])
  uploadedBy LibraryResourceUser @relation(fields: [uploadedById], references: [id])

  @@index([platformId])
  @@index([subjectId])
  @@index([topicId])
  @@index([uploadedById])
  @@index([status])
  @@index([dueDate])
}

/// External links attached to library content (subjects or topics).
/// Course owners can add helpful external links like reference materials, videos, articles, etc.
model LibraryLink {
  id         String  @id @default(cuid())
  platformId String
  subjectId  String
  topicId    String? // Optional - can be attached to topic

  uploadedById String // Tracks which library user added this link

  title       String
  description String?
  url         String // The external link URL
  linkType    String? // e.g., "article", "video", "reference", "tutorial", "documentation", etc.

  // Optional metadata
  thumbnailUrl String? // Preview thumbnail if available
  domain       String? // Extracted domain name for display

  status LibraryContentStatus @default(published)
  order  Int                  @default(1)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  platform   LibraryPlatform     @relation(fields: [platformId], references: [id])
  subject    LibrarySubject      @relation(fields: [subjectId], references: [id])
  topic      LibraryTopic?       @relation(fields: [topicId], references: [id])
  uploadedBy LibraryResourceUser @relation(fields: [uploadedById], references: [id])

  @@index([platformId])
  @@index([subjectId])
  @@index([topicId])
  @@index([uploadedById])
  @@index([status])
}

/// Assessments created by librarians for public library content.
/// These assessments can be attached to a subject (whole) or topic.
/// Any user can take these assessments regardless of their school.
model LibraryAssessment {
  id          String  @id @default(cuid())
  platformId  String
  subjectId   String // Required - always attached to a subject
  topicId     String? // Optional - for topic-level assessments
  createdById String // LibraryResourceUser who created this assessment

  title        String
  description  String?
  instructions String?

  // Assessment settings
  assessmentType AssessmentType @default(CBT)
  gradingType    GradingType    @default(AUTOMATIC)
  status         QuizStatus     @default(DRAFT)

  // Timing
  duration  Int? // Duration in minutes
  timeLimit Int? // Time limit in seconds
  startDate DateTime?
  endDate   DateTime?

  // Attempt settings
  maxAttempts Int     @default(1)
  allowReview Boolean @default(true)
  autoSubmit  Boolean @default(false)

  // Grading settings
  totalPoints           Float   @default(100.0)
  passingScore          Float   @default(50.0)
  showCorrectAnswers    Boolean @default(false)
  showFeedback          Boolean @default(true)
  studentCanViewGrading Boolean @default(true)

  // Question settings
  shuffleQuestions Boolean @default(false)
  shuffleOptions   Boolean @default(false)

  // Publishing
  isPublished      Boolean   @default(false)
  publishedAt      DateTime?
  isResultReleased Boolean   @default(false)
  resultReleasedAt DateTime?

  // Metadata
  tags  String[] @default([])
  order Int      @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  platform  LibraryPlatform     @relation(fields: [platformId], references: [id])
  subject   LibrarySubject      @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  topic     LibraryTopic?       @relation(fields: [topicId], references: [id], onDelete: Cascade)
  createdBy LibraryResourceUser @relation(fields: [createdById], references: [id])

  // Assessment content
  questions LibraryAssessmentQuestion[]
  attempts  LibraryAssessmentAttempt[]
  analytics LibraryAssessmentAnalytics?

  @@index([platformId])
  @@index([subjectId])
  @@index([topicId])
  @@index([createdById])
  @@index([status])
  @@index([isPublished])
  @@index([assessmentType])
  @@index([startDate, endDate])
}

/// Questions within a library assessment
model LibraryAssessmentQuestion {
  id                    String          @id @default(cuid())
  assessmentId          String
  questionText          String
  questionType          QuestionType
  order                 Int
  points                Float           @default(1.0)
  isRequired            Boolean         @default(true)
  timeLimit             Int?
  imageUrl              String?
  imageS3Key            String?
  audioUrl              String?
  videoUrl              String?
  allowMultipleAttempts Boolean         @default(false)
  showHint              Boolean         @default(false)
  hintText              String?
  minLength             Int?
  maxLength             Int?
  minValue              Float?
  maxValue              Float?
  explanation           String?
  difficultyLevel       DifficultyLevel @default(MEDIUM)
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt

  assessment     LibraryAssessment                @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  correctAnswers LibraryAssessmentCorrectAnswer[]
  options        LibraryAssessmentOption[]
  responses      LibraryAssessmentResponse[]

  @@index([assessmentId, order])
  @@index([questionType])
}

/// Options for multiple choice questions in library assessments
model LibraryAssessmentOption {
  id         String   @id @default(cuid())
  questionId String
  optionText String
  order      Int
  isCorrect  Boolean  @default(false)
  imageUrl   String?
  audioUrl   String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  question  LibraryAssessmentQuestion   @relation(fields: [questionId], references: [id], onDelete: Cascade)
  responses LibraryAssessmentResponse[] @relation("LibraryResponseOptions")

  @@index([questionId, order])
}

/// Correct answers for library assessment questions
model LibraryAssessmentCorrectAnswer {
  id           String    @id @default(cuid())
  questionId   String
  answerText   String?
  answerNumber Float?
  answerDate   DateTime?
  optionIds    String[]
  answerJson   Json?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  question LibraryAssessmentQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@index([questionId])
}

/// Attempts by users taking library assessments (public, not tied to school)
model LibraryAssessmentAttempt {
  id              String            @id @default(cuid())
  assessmentId    String
  userId          String // Regular User ID (can be from any school)
  attemptNumber   Int               @default(1)
  status          QuizAttemptStatus @default(NOT_STARTED)
  startedAt       DateTime?
  submittedAt     DateTime?
  timeSpent       Int? // Time spent in seconds
  totalScore      Float             @default(0)
  maxScore        Float
  percentage      Float             @default(0)
  passed          Boolean           @default(false)
  isGraded        Boolean           @default(false)
  gradedAt        DateTime?
  gradedBy        String? // User ID who graded (if manual)
  overallFeedback String?
  gradeLetter     String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  assessment LibraryAssessment           @relation(fields: [assessmentId], references: [id])
  user       User                        @relation(fields: [userId], references: [id])
  grader     User?                       @relation("LibraryAssessmentGrader", fields: [gradedBy], references: [id])
  responses  LibraryAssessmentResponse[]

  @@unique([assessmentId, userId, attemptNumber])
  @@index([assessmentId])
  @@index([userId])
  @@index([status])
  @@index([submittedAt])
}

/// Responses to questions in library assessment attempts
model LibraryAssessmentResponse {
  id              String    @id @default(cuid())
  attemptId       String
  questionId      String
  userId          String
  textAnswer      String?
  numericAnswer   Float?
  dateAnswer      DateTime?
  selectedOptions String[]
  fileUrls        String[]
  isCorrect       Boolean?
  pointsEarned    Float     @default(0)
  maxPoints       Float
  timeSpent       Int?
  feedback        String?
  isGraded        Boolean   @default(false)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  attempt            LibraryAssessmentAttempt  @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  question           LibraryAssessmentQuestion @relation(fields: [questionId], references: [id])
  user               User                      @relation(fields: [userId], references: [id])
  selectedOptionRefs LibraryAssessmentOption[] @relation("LibraryResponseOptions")

  @@unique([attemptId, questionId])
  @@index([attemptId])
  @@index([questionId])
  @@index([userId])
}

/// Analytics for library assessments
model LibraryAssessmentAnalytics {
  id              String   @id @default(cuid())
  assessmentId    String   @unique
  totalAttempts   Int      @default(0)
  totalUsers      Int      @default(0)
  averageScore    Float    @default(0)
  averageTime     Int      @default(0)
  passRate        Float    @default(0)
  questionStats   Json
  dailyAttempts   Json
  hourlyAttempts  Json
  completionRate  Float    @default(0)
  abandonmentRate Float    @default(0)
  lastUpdated     DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  assessment LibraryAssessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)

  @@index([assessmentId])
}

/// Non-video study materials under each topic/subject in a library:
/// PDFs, notes, slides, links, etc. Files should live in S3.
model LibraryMaterial {
  id           String  @id @default(cuid())
  platformId   String
  subjectId    String
  topicId      String?
  uploadedById String // Tracks which library user uploaded this material

  title       String
  description String?

  materialType LibraryMaterialType @default(PDF)
  url          String // Public or signed URL
  s3Key        String? // S3 object key

  sizeBytes Int?
  pageCount Int?

  status LibraryContentStatus @default(published)
  order  Int                  @default(1)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  platform   LibraryPlatform     @relation(fields: [platformId], references: [id])
  subject    LibrarySubject      @relation(fields: [subjectId], references: [id])
  topic      LibraryTopic?       @relation(fields: [topicId], references: [id])
  uploadedBy LibraryResourceUser @relation(fields: [uploadedById], references: [id])

  @@index([platformId])
  @@index([subjectId])
  @@index([topicId])
  @@index([uploadedById])
  @@index([status])
}

// ==================== GENERAL MATERIALS (E-COMMERCE) ====================

/// Standalone ebooks/textbooks that can be sold and have AI chat capabilities.
/// These are NOT tied to the educational hierarchy (class/subject/topic).
model LibraryGeneralMaterial {
  id           String @id @default(cuid())
  platformId   String
  uploadedById String

  // Basic Info
  title       String
  description String?
  author      String?
  isbn        String?
  publisher   String?

  // File Info
  materialType   LibraryMaterialType @default(PDF)
  url            String // Main file URL
  s3Key          String? // S3 object key
  sizeBytes      Int?
  pageCount      Int?
  thumbnailUrl   String?
  thumbnailS3Key String?

  // Access / Pricing Fields (school-tier based, NOT per-user purchase)
  price       Float? // Price used for school tier/subscription plans (null = included in free tier)
  currency    String? @default("NGN") // Currency code
  isFree      Boolean @default(false) // True = available on free tier for all schools
  isAvailable Boolean @default(true) // For inventory/visibility management

  // Optional Educational Attachment (for categorization)
  // classId removed - now using many-to-many relationship via LibraryGeneralMaterialClass
  subjectId String? // Optional - can be attached to a subject for organization

  // AI Chat Support
  isAiEnabled      Boolean                  @default(false) // Master switch - if false, no chapters can be AI-enabled
  processingStatus MaterialProcessingStatus @default(PENDING)

  // Metadata
  status     LibraryContentStatus @default(published)
  order      Int                  @default(1)
  views      Int                  @default(0)
  downloads  Int                  @default(0)
  salesCount Int                  @default(0) // Number of school-level activations / tier-inclusions

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  platform   LibraryPlatform     @relation(fields: [platformId], references: [id])
  uploadedBy LibraryResourceUser @relation(fields: [uploadedById], references: [id])
  subject    LibrarySubject?     @relation(fields: [subjectId], references: [id])
  classes    LibraryGeneralMaterialClass[] // Many-to-many relationship with LibraryClass

  // Chapters for AI chunking
  chapters LibraryGeneralMaterialChapter[]

  // Processing & AI
  processing LibraryGeneralMaterialProcessing?
  chunks     LibraryGeneralMaterialChunk[]

  // Purchases
  purchases LibraryGeneralMaterialPurchase[]

  // Chat conversations
  chatConversations                  LibraryGeneralMaterialChatConversation[]
  libraryGeneralMaterialChatMessages LibraryGeneralMaterialChatMessage[]
  libraryGeneralMaterialChatContexts LibraryGeneralMaterialChatContext[]

  @@index([platformId])
  @@index([uploadedById])
  @@index([subjectId])
  @@index([status])
  @@index([isAiEnabled])
  @@index([price])
  @@index([createdAt])
}

/// Junction table for many-to-many relationship between LibraryGeneralMaterial and LibraryClass
model LibraryGeneralMaterialClass {
  id         String @id @default(cuid())
  materialId String
  classId    String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  material LibraryGeneralMaterial @relation(fields: [materialId], references: [id], onDelete: Cascade)
  class    LibraryClass           @relation(fields: [classId], references: [id], onDelete: Cascade)

  @@unique([materialId, classId])
  @@index([materialId])
  @@index([classId])
  @@index([createdAt])
}

/// Chapters within a general material for AI chunking
model LibraryGeneralMaterialChapter {
  id         String @id @default(cuid())
  materialId String
  platformId String

  title       String
  description String?
  pageStart   Int? // Starting page number
  pageEnd     Int? // Ending page number
  order       Int     @default(1)

  // Status (soft delete)
  chapterStatus ChapterStatus @default(active) // active = visible, deleted = soft deleted (hidden but kept for chat history)

  // AI Processing
  isAiEnabled Boolean @default(false) // Whether AI chat is enabled for this chapter
  isProcessed Boolean @default(false) // Whether the chapter has been processed/chunked for AI
  chunkCount  Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  material LibraryGeneralMaterial              @relation(fields: [materialId], references: [id], onDelete: Cascade)
  platform LibraryPlatform                     @relation(fields: [platformId], references: [id])
  chunks   LibraryGeneralMaterialChunk[]
  files    LibraryGeneralMaterialChapterFile[]

  @@index([materialId])
  @@index([platformId])
  @@index([order])
  @@index([isAiEnabled])
  @@index([chapterStatus])
}

/// Files attached to general material chapters
/// A chapter can have multiple files (e.g., PDF, DOC, images, etc.)
model LibraryGeneralMaterialChapterFile {
  id           String @id @default(cuid())
  chapterId    String
  platformId   String
  uploadedById String // Tracks which library user uploaded this file

  // File Info
  fileName  String // Original file name
  fileType  LibraryMaterialType @default(PDF)
  url       String // Public or signed URL
  s3Key     String? // S3 object key
  sizeBytes Int?
  pageCount Int?

  // Metadata
  title       String? // Optional title/description for the file
  description String?
  order       Int     @default(1) // Order within the chapter

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  chapter    LibraryGeneralMaterialChapter @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  platform   LibraryPlatform               @relation(fields: [platformId], references: [id])
  uploadedBy LibraryResourceUser           @relation(fields: [uploadedById], references: [id])

  @@index([chapterId])
  @@index([platformId])
  @@index([uploadedById])
  @@index([order])
}

/// AI Processing status for general materials
model LibraryGeneralMaterialProcessing {
  id         String @id @default(cuid())
  materialId String @unique
  platformId String

  status          MaterialProcessingStatus @default(PENDING)
  totalChunks     Int                      @default(0)
  processedChunks Int                      @default(0)
  failedChunks    Int                      @default(0)

  processingStartedAt   DateTime?
  processingCompletedAt DateTime?
  errorMessage          String?
  retryCount            Int       @default(0)

  vectorDatabaseId String?
  embeddingModel   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  material LibraryGeneralMaterial        @relation(fields: [materialId], references: [id], onDelete: Cascade)
  platform LibraryPlatform               @relation(fields: [platformId], references: [id])
  chunks   LibraryGeneralMaterialChunk[]

  @@index([platformId])
  @@index([status])
}

/// AI Chunks for general materials
model LibraryGeneralMaterialChunk {
  id           String  @id @default(cuid())
  materialId   String
  chapterId    String?
  processingId String
  platformId   String

  content        String
  chunkType      ChunkType             @default(TEXT)
  pageNumber     Int?
  sectionTitle   String?
  embedding      Unsupported("vector") // Vector embedding for AI
  embeddingModel String
  tokenCount     Int                   @default(0)
  wordCount      Int                   @default(0)
  orderIndex     Int
  keywords       String[]              @default([])
  summary        String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  material     LibraryGeneralMaterial              @relation(fields: [materialId], references: [id], onDelete: Cascade)
  chapter      LibraryGeneralMaterialChapter?      @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  processing   LibraryGeneralMaterialProcessing    @relation(fields: [processingId], references: [id], onDelete: Cascade)
  platform     LibraryPlatform                     @relation(fields: [platformId], references: [id])
  chatContexts LibraryGeneralMaterialChatContext[]

  @@index([materialId])
  @@index([chapterId])
  @@index([processingId])
  @@index([platformId])
  @@index([orderIndex])
}

/// Purchase tracking for general materials
/// School-level purchase/activation of a general material (not per individual end-user).
model LibraryGeneralMaterialPurchase {
  id         String @id @default(cuid())
  materialId String
  userId     String // Admin/billing user representing the school that activated this material
  platformId String

  price         Float // Price paid at time of activation (typically at school-tier level)
  currency      String  @default("NGN")
  paymentMethod String? // e.g., "card", "bank_transfer", "wallet"
  transactionId String? // External payment transaction ID

  status PurchaseStatus @default(PENDING) // PENDING, COMPLETED, FAILED, REFUNDED

  purchasedAt DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  material LibraryGeneralMaterial @relation(fields: [materialId], references: [id])
  user     User                   @relation(fields: [userId], references: [id])
  platform LibraryPlatform        @relation(fields: [platformId], references: [id])

  @@index([materialId])
  @@index([userId])
  @@index([platformId])
  @@index([status])
  @@index([purchasedAt])
}

/// AI Chat conversations for general materials
model LibraryGeneralMaterialChatConversation {
  id         String @id @default(cuid())
  userId     String
  materialId String
  platformId String

  title          String?
  status         ConversationStatus @default(ACTIVE)
  systemPrompt   String?
  contextSummary String?
  totalMessages  Int                @default(0)
  lastActivity   DateTime           @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user     User                                @relation(fields: [userId], references: [id])
  material LibraryGeneralMaterial              @relation(fields: [materialId], references: [id])
  platform LibraryPlatform                     @relation(fields: [platformId], references: [id])
  messages LibraryGeneralMaterialChatMessage[]
  contexts LibraryGeneralMaterialChatContext[]

  @@index([userId])
  @@index([materialId])
  @@index([platformId])
  @@index([status])
}

/// Chat messages for general materials
model LibraryGeneralMaterialChatMessage {
  id             String @id @default(cuid())
  conversationId String
  materialId     String
  userId         String

  role       MessageRole // USER, ASSISTANT, SYSTEM
  content    String
  tokensUsed Int?
  model      String?

  // Context from chunks
  referencedChunks String[] // IDs of chunks used for context

  createdAt DateTime @default(now())

  conversation LibraryGeneralMaterialChatConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  material     LibraryGeneralMaterial                 @relation(fields: [materialId], references: [id])
  user         User                                   @relation(fields: [userId], references: [id])

  @@index([conversationId])
  @@index([materialId])
  @@index([userId])
  @@index([createdAt])
}

/// Chat context from chunks
model LibraryGeneralMaterialChatContext {
  id             String @id @default(cuid())
  conversationId String
  chunkId        String
  materialId     String

  relevanceScore Float?
  createdAt      DateTime @default(now())

  conversation LibraryGeneralMaterialChatConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  chunk        LibraryGeneralMaterialChunk            @relation(fields: [chunkId], references: [id])
  material     LibraryGeneralMaterial                 @relation(fields: [materialId], references: [id])

  @@index([conversationId])
  @@index([chunkId])
  @@index([materialId])
}
